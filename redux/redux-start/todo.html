<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/redux@latest/dist/redux.min.js"></script>
    <title>Redux - Todo</title>
  </head>
  <body>
    <h3>오늘 할 일</h3>
    <ul id="todo-list"></ul>

    <div>
      <input type="text" id="input-text" />
      <button id="add-button">할 일 추가</button>
      <button id="remove-button">할 일 삭제</button>
      <button id="remove-all-button">모두 삭제</button>
      <button id="logging-state">State Logging</button>
    </div>

    <script>
      const ACTION_TYPE_ADD_TODO = "ADD_TODO";
      const ACTION_TYPE_REMOVE_TODO = "REMOVE_TODO";
      const ACTION_TYPE_REMOVE_ALL = "REMOVE_ALL";

      function todoReducer(state, action) {
        switch (action.type) {
          case ACTION_TYPE_ADD_TODO:
            return state.concat(action.text);
          case ACTION_TYPE_REMOVE_TODO:
            return state.slice(0, -1); // slice함수를 사용하면 새로운 배열이 만들어짐
          case ACTION_TYPE_REMOVE_ALL:
            return [];
          default:
            return state;
        }
      }

      function loggerMiddleware({ getState }) {
        return (next) => (action) => {
          console.log("dispatch 예정 action", action);

          // Middleware chain에 있는 다음 dispatch 함수를 호출
          const returnValue = next(action);

          console.log("dispatch 이후 state", getState());

          return returnValue;
        };
      }

      let store = Redux.createStore(
        todoReducer,
        [],
        Redux.applyMiddleware(loggerMiddleware)
      );

      let todoListElement = document.getElementById("todo-list");
      let inputElement = document.getElementById("input-text");

      function render() {
        // 이전 목록 초기화
        todoListElement.innerHTML = "";

        store.getState().forEach((todo) => {
          const todoListItemElement = document.createElement("li");
          todoListItemElement.textContent = todo;
          todoListElement.appendChild(todoListItemElement);
        });
      }

      render();
      store.subscribe(render);

      function addTodoActionCreator(text) {
        return {
          type: ACTION_TYPE_ADD_TODO,
          text,
        };
      }

      function removeTodoActionCreator() {
        return {
          type: ACTION_TYPE_REMOVE_TODO,
        };
      }
      function removeAllActionCreator() {
        return {
          type: ACTION_TYPE_REMOVE_ALL,
        };
      }

      document.getElementById("add-button").addEventListener("click", () => {
        if (!inputElement.value) {
          alert("값을 입력해주세요.");
          return;
        }
        store.dispatch(addTodoActionCreator(inputElement.value));

        inputElement.value = "";
      });

      document.getElementById("remove-button").addEventListener("click", () => {
        const currentStore = store.getState();
        if (!currentStore.length) {
          alert("등록된 할 일이 없습니다.");
          return;
        }

        store.dispatch(removeTodoActionCreator());
      });

      document
        .getElementById("remove-all-button")
        .addEventListener("click", () => {
          const currentStore = store.getState();
          if (!currentStore.length) {
            alert("등록된 할 일이 없습니다.");
            return;
          }

          store.dispatch(removeAllActionCreator());
        });

      document.getElementById("logging-state").addEventListener("click", () => {
        console.log("현재 state", store.getState());
      });
    </script>
  </body>
</html>
